
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Digital LR – Jai Ambey Logistics Service</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 1rem; }
    header, section { margin-bottom: 1rem; }
    h1, h2, h3 { margin: 0.2rem 0 0.5rem; }
    .row { display: grid; grid-template-columns: repeat(4, minmax(160px, 1fr)); gap: 0.75rem; }
    .row-2 { grid-template-columns: repeat(2, minmax(160px, 1fr)); }
    .row-3 { grid-template-columns: repeat(3, minmax(160px, 1fr)); }
    label { font-size: 0.9rem; display: block; margin-bottom: 0.25rem; }
    input, select, textarea { width: 100%; padding: 0.5rem; font-size: 0.95rem; }
    textarea { min-height: 80px; }
    .toolbar { display: flex; gap: 0.5rem; flex-wrap: wrap; margin: 0.5rem 0 1rem; }
    .toolbar button { padding: 0.5rem 0.75rem; }
    .pill { padding: 0.25rem 0.5rem; border: 1px solid #ddd; border-radius: 999px; font-size: 0.8rem; }
    .masters { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; }
    .add { font-size: 0.85rem; cursor: pointer; color: #0066cc; }
    .warn { color: #8a6d3b; background: #fcf8e3; border: 1px solid #faebcc; padding: 0.5rem; }
    @media print {
      @page { size: A4 landscape; margin: 1cm; }
      .no-print { display: none !important; }
      body { padding: 0; }
    }
  </style>
</head>
<body>
  <header>
    <h1>JAI AMBEY LOGISTICS SERVICE</h1>
    <div>FLEET OWNER & TRANSPORT CONTRACTOR</div>
    <div>Ground Floor, No.33, Dasanapura Hobli, Tumakur Road, 1st Main, Madanayakanahalli Village, Near Shivaganga Hospital, Bengaluru Urban, Karnataka, 562162</div>
    <div>E-Mail: jaiambey.logisticsservice@gmail.com • Mob: 8951746209, 9513240005</div>

    <div class="toolbar no-print">
      <button id="btnSignIn">Sign in</button>
      <button id="btnSignOut">Sign out</button>
      <span id="authStatus" class="pill">Not signed in</span>
    </div>

    <div class="toolbar no-print">
      <button id="btnNew">New</button>
      <button id="btnSave">Save</button>
      <button id="btnShare">Share Link</button>
      <button onclick="window.print()">Print A4 Landscape</button>
      <span id="saveStatus" class="pill">Idle</span>
    </div>
  </header>

  <main>
    <!-- LR Header -->
    <section>
      <h2>Create / Edit LR</h2>
      <div class="row">
        <div><label for="cnNoteNo">CN NOTE NO.</label><input id="cnNoteNo" /></div>
        <div><label for="date">Date</label><input id="date" type="date" /></div>
        <div><label for="salesTaxPermitNo">Sales Tax Permit No.</label><input id="salesTaxPermitNo" /></div>
        <div><label for="gstin">GSTIN</label><input id="gstin" /></div>
        <div><label for="pan">PAN</label><input id="pan" /></div>
      </div>

      <div class="warn" style="margin-top:0.75rem;">
        CAUTION! This consignment will not be detained, diverted, re-routed or re-booked without Consignee/Bank's written permission and will be delivered only at the destination.
      </div>

      <h3>INSURANCE</h3>
      <div class="row">
        <div><label for="insured">Consignment Insured?</label>
          <select id="insured"><option value="No">No</option><option value="Yes">Yes</option></select>
        </div>
        <div><label for="company">Company</label><input id="company" /></div>
        <div><label for="policyNo">Policy No</label><input id="policyNo" /></div>
        <div><label for="amount">Amount</label><input id="amount" type="number" /></div>
        <div><label for="risk">Risk</label><input id="risk" /></div>
      </div>
    </section>

    <!-- Parties -->
    <section>
      <h3>Parties</h3>
      <div class="row">
        <div>
          <label for="consignorId">Consignor</label>
          <div style="display:flex; gap:0.5rem;">
            <select id="consignorId"></select>
            <span class="add no-print" id="addConsignor">+ Add</span>
          </div>
        </div>
        <div>
          <label for="consigneeId">Consignee</label>
          <div style="display:flex; gap:0.5rem;">
            <select id="consigneeId"></select>
            <span class="add no-print" id="addConsignee">+ Add</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Route -->
    <section>
      <h3>Route</h3>
      <div class="row">
        <div><label for="from">From</label><input id="from" /></div>
        <div><label for="to">To</label><input id="to" /></div>
        <div><label for="invoiceNo">Invoice No.</label><input id="invoiceNo" /></div>
        <div><label for="invoiceDate">Invoice Date</label><input id="invoiceDate" type="date" /></div>
      </div>
    </section>

    <!-- Packing / Material -->
    <section>
      <h3>Packing / Material</h3>
      <div class="row">
        <div><label for="pkgQty">PKG/QTY</label><input id="pkgQty" /></div>
        <div><label for="pkgType">Type</label><input id="pkgType" /></div>
        <div><label for="description">Description (said to contain)</label><textarea id="description"></textarea></div>
        <div><label for="actualWeightKg">Actual Weight (kg)</label><input id="actualWeightKg" type="number" step="0.01" /></div>
      </div>
    </section>

    <!-- Vehicle / Freight -->
    <section>
      <h3>Vehicle / Freight</h3>
      <div class="row">
        <div>
          <label for="vehicleTypeId">Vehicle Type</label>
          <div style="display:flex; gap:0.5rem;">
            <select id="vehicleTypeId"></select>
            <span class="add no-print" id="addVehicleType">+ Add</span>
          </div>
        </div>
        <div><label for="vehicleNo">Vehicle No.</label><input id="vehicleNo" /></div>
        <div><label for="freightMode">Freight Mode</label>
          <select id="freightMode">
            <option value="TBB/PAID">TBB/PAID</option>
            <option value="TO PAY">TO PAY</option>
          </select>
        </div>
        <div><label for="charges">Charges (₹)</label><input id="charges" type="number" step="0.01" /></div>
        <div><label for="remarks">Remarks</label><input id="remarks" /></div>
      </div>
    </section>

    <!-- Tax / Value -->
    <section>
      <h3>Tax / Value</h3>
      <div class="row row-3">
        <div><label for="serviceTaxPayableBy">Service Tax Payable by</label>
          <select id="serviceTaxPayableBy">
            <option value="Consignee">Consignee</option>
            <option value="Consignor">Consignor</option>
            <option value="Transporter">Transporter</option>
          </select>
        </div>
        <div><label for="value">Value (₹)</label><input id="value" type="number" step="0.01" /></div>
      </div>
    </section>

    <!-- Notice -->
    <section>
      <h4>NOTICE</h4>
      <p>
        The consignment covered by this special Lorry Receipt shall be stored at the destination under the control of the
        Transport Operator and shall be delivered to the order of the Consignee/Bank whose name is mentioned in the Lorry Receipt.
        It will under no circumstances be delivered to anyone without written authority from the Consignee/Bank or its order endorsed
        on the Consignee copy or on a separate Letter of Authority.
      </p>
    </section>
  </main>

  <!-- Firebase + App Logic -->
  <script type="module">
    // ---- Firebase imports (SDK v12.7.0) ----
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import {
      getFirestore, enableIndexedDbPersistence, collection, doc, setDoc, addDoc,
      getDoc, getDocs, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    // ---- Your Firebase config ----
    const firebaseConfig = {
      apiKey: "AIzaSyBXqVfPkMqqQxNclyyYe0oM9o0eKIM2VwE",
      authDomain: "lr-jails.firebaseapp.com",
      projectId: "lr-jails",
      storageBucket: "lr-jails.firebasestorage.app",
      messagingSenderId: "716098447406",
      appId: "1:716098447406:web:3e21b38cb09772b44e97bf",
      measurementId: "G-M1QVW7SJTQ"
    };

    // ---- Initialize Firebase ----
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    enableIndexedDbPersistence(db).catch(err => console.warn("Persistence failed:", err));

    // ---- Auth UI ----
    const $ = (id) => document.getElementById(id);
    const btnSignIn = $('btnSignIn');
    const btnSignOut = $('btnSignOut');
    const authStatus = $('authStatus');
    const saveStatus = $('saveStatus');

    let currentUser = null;
    let currentLRId = null;

    btnSignIn.onclick = async () => {
      try {
        await signInWithPopup(auth, new GoogleAuthProvider());
      } catch (e) {
        console.error(e);
        alert("Sign in failed: " + (e && e.message ? e.message : e));
      }
    };
    btnSignOut.onclick = () => signOut(auth);

    onAuthStateChanged(auth, async (user) => {
      currentUser = user || null;
      authStatus.textContent = user ? `Signed in as ${user.displayName || user.email}` : "Not signed in";
      if (user) {
        await loadMasters();
        await loadLRFromURL();
      }
    });

    function updateSaveStatus(msg) { saveStatus.textContent = msg; }

    function readForm() {
      return {
        ownerUid: currentUser ? currentUser.uid : null,
        header: {
          cnNoteNo: $('cnNoteNo').value.trim(),
          date: $('date').value || null,
          salesTaxPermitNo: $('salesTaxPermitNo').value.trim(),
          gstin: $('gstin').value.trim(),
          pan: $('pan').value.trim(),
        },
        insurance: {
          insured: $('insured').value,
          company: $('company').value.trim(),
          policyNo: $('policyNo').value.trim(),
          amount: Number($('amount').value || 0),
          risk: $('risk').value.trim(),
        },
        parties: {
          consignorId: $('consignorId').value || null,
          consigneeId: $('consigneeId').value || null,
        },
        route: {
          from: $('from').value.trim(),
          to: $('to').value.trim(),
          invoiceNo: $('invoiceNo').value.trim(),
          invoiceDate: $('invoiceDate').value || null,
        },
        packing: {
          pkgQty: $('pkgQty').value.trim(),
          pkgType: $('pkgType').value.trim(),
          description: $('description').value.trim(),
          actualWeightKg: Number($('actualWeightKg').value || 0),
        },
        vehicle: {
          vehicleTypeId: $('vehicleTypeId').value || null,
          vehicleNo: $('vehicleNo').value.trim(),
          freightMode: $('freightMode').value,
          charges: Number($('charges').value || 0),
          remarks: $('remarks').value.trim(),
        },
        tax: {
          serviceTaxPayableBy: $('serviceTaxPayableBy').value,
          value: Number($('value').value || 0),
        },
        updatedAt: serverTimestamp(),
        createdAt: serverTimestamp(),
      };
    }

    function fillForm(docData) {
      const { header, insurance, parties, route, packing, vehicle, tax } = docData;
      if (header) {
        $('cnNoteNo').value = header.cnNoteNo || '';
        $('date').value = header.date || '';
        $('salesTaxPermitNo').value = header.salesTaxPermitNo || '';
        $('gstin').value = header.gstin || '';
        $('pan').value = header.pan || '';
      }
      if (insurance) {
        $('insured').value = insurance.insured || 'No';
        $('company').value = insurance.company || '';
        $('policyNo').value = insurance.policyNo || '';
        $('amount').value = insurance.amount ?? '';
        $('risk').value = insurance.risk || '';
      }
      if (parties) {
        $('consignorId').value = parties.consignorId || '';
        $('consigneeId').value = parties.consigneeId || '';
      }
      if (route) {
        $('from').value = route.from || '';
        $('to').value = route.to || '';
        $('invoiceNo').value = route.invoiceNo || '';
        $('invoiceDate').value = route.invoiceDate || '';
      }
      if (packing) {
        $('pkgQty').value = packing.pkgQty || '';
        $('pkgType').value = packing.pkgType || '';
        $('description').value = packing.description || '';
        $('actualWeightKg').value = packing.actualWeightKg ?? '';
      }
      if (vehicle) {
        $('vehicleTypeId').value = vehicle.vehicleTypeId || '';
        $('vehicleNo').value = vehicle.vehicleNo || '';
        $('freightMode').value = vehicle.freightMode || 'TBB/PAID';
        $('charges').value = vehicle.charges ?? '';
        $('remarks').value = vehicle.remarks || '';
      }
      if (tax) {
        $('serviceTaxPayableBy').value = tax.serviceTaxPayableBy || 'Consignee';
        $('value').value = tax.value ?? '';
      }
    }

    function clearForm() {
      document.querySelectorAll('input, select, textarea').forEach(el => el.value = '');
      $('freightMode').value = 'TBB/PAID';
      $('insured').value = 'No';
      $('serviceTaxPayableBy').value = 'Consignee';
      currentLRId = null;
      updateSaveStatus('Idle');
      history.replaceState({}, '', location.pathname);
    }
    $('btnNew').onclick = clearForm;

    // ---- Masters (Consignors, Consignees, Vehicle Types) ----
    async function loadMasters() {
      await Promise.all([
        loadMasterCollection('consignors', $('consignorId')),
        loadMasterCollection('consignees', $('consigneeId')),
        loadMasterCollection('vehicleTypes', $('vehicleTypeId')),
      ]);
    }
    async function loadMasterCollection(colName, selectEl) {
      selectEl.innerHTML = '<option value="">— Select —</option>';
      const qSnap = await getDocs(collection(db, colName));
      qSnap.forEach(docSnap => {
        const opt = document.createElement('option');
        opt.value = docSnap.id;
        opt.textContent = docSnap.data().name;
        selectEl.appendChild(opt);
      });
    }
    async function addMaster(colName, promptText) {
      if (!currentUser) return alert('Please sign in first.');
      const name = (prompt(promptText) || '').trim();
      if (!name) return;
      await addDoc(collection(db, colName), {
        name, ownerUid: currentUser.uid, createdAt: serverTimestamp(), updatedAt: serverTimestamp()
      });
      await loadMasters();
    }
    $('addConsignor').onclick = () => addMaster('consignors', 'Enter consignor name');
    $('addConsignee').onclick = () => addMaster('consignees', 'Enter consignee name');
    $('addVehicleType').onclick = () => addMaster('vehicleTypes', 'Enter vehicle type');

    // ---- LR Save / Share / Load ----
    $('btnSave').onclick = async () => {
      try {
        if (!currentUser) return alert('Please sign in first.');
        const data = readForm();

        // Determine document ID
        let id = currentLRId;
        const cn = (data.header.cnNoteNo || '').trim();
        if (!id) {
          if (cn) {
            id = cn.replace(/[^A-Za-z0-9_-]/g, '_'); // sanitize
          } else {
            const docRef = await addDoc(collection(db, 'lrs'), { temp: true, ownerUid: currentUser.uid, createdAt: serverTimestamp() });
            id = docRef.id;
          }
          currentLRId = id;
        }

        await setDoc(doc(db, 'lrs', id), data, { merge: true });
        updateSaveStatus(`Saved (ID: ${id})`);
      } catch (e) {
        console.error(e);
        alert('Save failed: ' + e.message);
        updateSaveStatus('Error');
      }
    };

    function lrShareURL(id) {
      const u = new URL(location.href);
      u.searchParams.set('lrId', id);
      return u.toString();
    }
    $('btnShare').onclick = () => {
      if (!currentLRId) return alert('Save first to get an ID.');
      const url = lrShareURL(currentLRId);
      navigator.clipboard?.writeText(url);
      alert('Shareable link copied:\n' + url);
    };

    async function loadLRFromURL() {
      const id = new URL(location.href).searchParams.get('lrId');
      if (!id) return;
      try {
        const snap = await getDoc(doc(db, 'lrs', id));
        if (snap.exists()) {
          currentLRId = id;
          fillForm(snap.data());
          updateSaveStatus(`Loaded (ID: ${id})`);
        } else {
          alert('LR not found: ' + id);
        }
      } catch (e) {
        console.error(e);
        alert('Load failed: ' + e.message);
      }
    }
  </script>
</body>
</html>
